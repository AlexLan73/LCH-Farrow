#include "generator_gpu.h"
"
#include <iostream>
#include <vector>
#include <chrono>

using namespace radar;
using namespace radar::gpu;

int main() {
    std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
              << "GeneratorGPU - ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð›Ð§Ðœ Ð½Ð° GPU\n"
              << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
    
    try {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 1. Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ÐŸÐÐ ÐÐœÐ•Ð¢Ð ÐžÐ’ Ð›Ð§Ðœ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        LFMParameters params;
        params.f_start = 100.0f;           // 100 Ð“Ñ†
        params.f_stop = 500.0f;            // 500 Ð“Ñ†
        params.sample_rate = 12.0e6f;      // 12 ÐœÐ“Ñ†
        params.duration = 0.1f;            // 0.1 ÑÐµÐº
        params.num_beams = 256;            // 256 Ð»ÑƒÑ‡ÐµÐ¹
        params.steering_angle = 30.0f;     // 30 Ð³Ñ€Ð°Ð´ÑƒÑÐ¾Ð²
        
        // Ð’Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð¾Ð²
        size_t num_samples = static_cast<size_t>(params.duration * params.sample_rate);
        
        std::cout << "ðŸ“‹ ÐŸÐÐ ÐÐœÐ•Ð¢Ð Ð« Ð›Ð§Ðœ Ð¡Ð˜Ð“ÐÐÐ›Ð:\n"
                  << "  â€¢ Ð§Ð°ÑÑ‚Ð¾Ñ‚Ð° Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ: " << params.f_start << " Ð“Ñ†\n"
                  << "  â€¢ Ð§Ð°ÑÑ‚Ð¾Ñ‚Ð° ÐºÐ¾Ð½ÐµÑ‡Ð½Ð°Ñ: " << params.f_stop << " Ð“Ñ†\n"
                  << "  â€¢ Ð§Ð°ÑÑ‚Ð¾Ñ‚Ð° Ð´Ð¸ÑÐºÑ€ÐµÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸: " << params.sample_rate / 1e6f << " ÐœÐ“Ñ†\n"
                  << "  â€¢ Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: " << params.duration << " ÑÐµÐº\n"
                  << "  â€¢ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð»ÑƒÑ‡ÐµÐ¹: " << params.num_beams << "\n"
                  << "  â€¢ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð¾Ð² Ð½Ð° Ð»ÑƒÑ‡: " << num_samples << "\n"
                  << "  â€¢ Ð’ÑÐµÐ³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²: " << params.num_beams * num_samples << "\n"
                  << "  â€¢ ÐŸÐ°Ð¼ÑÑ‚ÑŒ Ð½Ð° GPU: " << (params.num_beams * num_samples * sizeof(std::complex<float>)) / (1024*1024)
                  << " MB\n\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 2. Ð¡ÐžÐ—Ð”ÐÐ¢Ð¬ Ð“Ð•ÐÐ•Ð ÐÐ¢ÐžÐ  GPU
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        std::cout << "âš™ï¸  Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ GPU...\n";
        auto time_start = std::chrono::high_resolution_clock::now();
        
        GeneratorGPU gen(params);
        
        auto time_init = std::chrono::high_resolution_clock::now();
        double init_time = std::chrono::duration<double, std::milli>(time_init - time_start).count();
        std::cout << "âœ“ GPU Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð·Ð° " << init_time << " Ð¼Ñ\n\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 3. Ð“Ð•ÐÐ•Ð Ð˜Ð ÐžÐ’ÐÐ¢Ð¬ Ð‘ÐÐ—ÐžÐ’Ð«Ð™ Ð›Ð§Ðœ Ð¡Ð˜Ð“ÐÐÐ›
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        std::cout << "ðŸ“¡ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð‘ÐÐ—ÐžÐ’ÐžÐ“Ðž Ð›Ð§Ðœ ÑÐ¸Ð³Ð½Ð°Ð»Ð° Ð½Ð° GPU...\n";
        auto time_gen_base = std::chrono::high_resolution_clock::now();
        
        cl_mem signal_base = gen.signal_base();
        
        auto time_gen_base_end = std::chrono::high_resolution_clock::now();
        double gen_base_time = std::chrono::duration<double, std::milli>(time_gen_base_end - time_gen_base).count();
        std::cout << "âœ“ signal_base() Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð·Ð° " << gen_base_time << " Ð¼Ñ\n\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 4. ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’Ð˜Ð¢Ð¬ ÐŸÐÐ ÐÐœÐ•Ð¢Ð Ð« Ð—ÐÐ”Ð•Ð Ð–ÐšÐ˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        std::cout << "ðŸ“Š ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð´Ð»Ñ " << params.num_beams << " Ð»ÑƒÑ‡ÐµÐ¹...\n";
        
        std::vector<DelayParameter> m_delay(params.num_beams);
        for (size_t beam = 0; beam < params.num_beams; ++beam) {
            // Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° = ÑˆÐ°Ð³ 0.5Â° * Ð½Ð¾Ð¼ÐµÑ€ Ð»ÑƒÑ‡Ð°
            // ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð»ÑƒÑ‡ 0 â†’ 0Â°, Ð»ÑƒÑ‡ 1 â†’ 0.5Â°, Ð»ÑƒÑ‡ 2 â†’ 1.0Â°, ...
            m_delay[beam].beam_index = beam;
            m_delay[beam].delay_degrees = (beam * 0.5f);  // 0, 0.5, 1.0, 1.5, ...
        }
        
        std::cout << "  â€¢ m_delay[0] = {beam_id: " << m_delay[0].beam_index 
                  << ", delay: " << m_delay[0].delay_degrees << "Â°}\n"
                  << "  â€¢ m_delay[128] = {beam_id: " << m_delay[128].beam_index 
                  << ", delay: " << m_delay[128].delay_degrees << "Â°}\n"
                  << "  â€¢ m_delay[255] = {beam_id: " << m_delay[255].beam_index 
                  << ", delay: " << m_delay[255].delay_degrees << "Â°}\n\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 5. Ð“Ð•ÐÐ•Ð Ð˜Ð ÐžÐ’ÐÐ¢Ð¬ Ð›Ð§Ðœ Ð¡ Ð”Ð ÐžÐ‘ÐÐžÐ™ Ð—ÐÐ”Ð•Ð Ð–ÐšÐžÐ™
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        std::cout << "ðŸ“¡ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð›Ð§Ðœ Ñ Ð”Ð ÐžÐ‘ÐÐžÐ™ Ð—ÐÐ”Ð•Ð Ð–ÐšÐžÐ™ Ð½Ð° GPU...\n";
        auto time_gen_delayed = std::chrono::high_resolution_clock::now();
        
        cl_mem signal_delayed = gen.signal_valedation(m_delay.data(), m_delay.size());
        
        auto time_gen_delayed_end = std::chrono::high_resolution_clock::now();
        double gen_delayed_time = std::chrono::duration<double, std::milli>(time_gen_delayed_end - time_gen_delayed).count();
        std::cout << "âœ“ signal_valedation() Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð·Ð° " << gen_delayed_time << " Ð¼Ñ\n\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 6. Ð¢Ð ÐÐÐ¡Ð¤Ð•Ð  Ð”ÐÐÐÐ«Ð¥ GPU â†’ CPU (Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        std::cout << "ðŸ“¤ Ð¢Ñ€Ð°Ð½ÑÑ„ÐµÑ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… GPU â†’ CPU (Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð»ÑƒÑ‡, Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð¾Ð²)...\n";
        
        size_t read_samples = std::min(size_t(10), num_samples);  // ÐŸÑ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10
        std::vector<std::complex<float>> cpu_data(read_samples);
        
        cl_int err = clEnqueueReadBuffer(
            gen.GetQueue(),
            signal_base,
            CL_TRUE,  // Blocking read
            0,        // Offset
            read_samples * sizeof(std::complex<float>),
            cpu_data.data(),
            0, nullptr, nullptr
        );
        
        if (err == CL_SUCCESS) {
            std::cout << "  âœ“ ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð»ÑƒÑ‡, Ð¿ÐµÑ€Ð²Ñ‹Ðµ " << read_samples << " Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð¾Ð² signal_base:\n";
            for (size_t i = 0; i < read_samples; ++i) {
                std::cout << "    [" << i << "] = " << cpu_data[i].real() 
                          << " + " << cpu_data[i].imag() << "j\n";
            }
        } else {
            std::cout << "  âš ï¸  ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ‡Ñ‚ÐµÐ½Ð¸Ð¸ Ð¸Ð· GPU (ÐºÐ¾Ð´: " << err << ")\n";
        }
        std::cout << "\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 7. Ð˜Ð¢ÐžÐ“ÐžÐ’ÐÐ¯ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        auto time_end = std::chrono::high_resolution_clock::now();
        double total_time = std::chrono::duration<double, std::milli>(time_end - time_start).count();
        
        std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
                  << "âœ… Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž\n"
                  << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
                  << "â±ï¸  Ð’Ð Ð•ÐœÐ¯ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð¯:\n"
                  << "  â€¢ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ GPU: " << init_time << " Ð¼Ñ\n"
                  << "  â€¢ signal_base(): " << gen_base_time << " Ð¼Ñ\n"
                  << "  â€¢ signal_valedation(): " << gen_delayed_time << " Ð¼Ñ\n"
                  << "  â€¢ Ð˜Ð¢ÐžÐ“Ðž: " << total_time << " Ð¼Ñ\n\n"
                  << "ðŸ“Š ÐŸÐ ÐžÐŸÐ£Ð¡ÐšÐÐÐ¯ Ð¡ÐŸÐžÐ¡ÐžÐ‘ÐÐžÐ¡Ð¢Ð¬ GPU:\n"
                  << "  â€¢ signal_base(): " 
                  << (params.num_beams * num_samples / (gen_base_time / 1000.0) / 1e9) << " Ð“Ð²Ñ‹Ð±/ÑÐµÐº\n"
                  << "  â€¢ signal_valedation(): " 
                  << (params.num_beams * num_samples / (gen_delayed_time / 1000.0) / 1e9) << " Ð“Ð²Ñ‹Ð±/ÑÐµÐº\n";
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 8. ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ (ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð² Ð´ÐµÑÑ‚Ñ€ÑƒÐºÑ‚Ð¾Ñ€Ðµ ~GeneratorGPU)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        std::cout << "ðŸ§¹ ÐžÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ GPU Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²...\n";
        // signal_base Ð¸ signal_delayed Ð±ÑƒÐ´ÑƒÑ‚ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
        // ÐºÐ¾Ð³Ð´Ð° Ð²Ñ‹Ð¹Ð´ÑƒÑ‚ Ð¸Ð· Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸ Ð²Ð¸Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ (RAII)
        
        std::cout << "âœ“ ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾!\n";
        
    } catch (const std::exception& e) {
        std::cerr << "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: " << e.what() << std::endl;
        return 1;
    }
    
    return 0;
}

